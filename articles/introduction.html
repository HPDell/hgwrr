<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>HGWR Model and How to Use It • hgwrr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="HGWR Model and How to Use It">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">hgwrr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5-0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/hgwrr.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/introduction.html">HGWR Model and How to Use It</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/HPDell/hgwrr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>HGWR Model and How to Use It</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/HPDell/hgwrr/blob/master/vignettes/articles/introduction.Rmd" class="external-link"><code>vignettes/articles/introduction.Rmd</code></a></small>
      <div class="d-none name"><code>introduction.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction-to-hgwr-model">Introduction to HGWR Model<a class="anchor" aria-label="anchor" href="#introduction-to-hgwr-model"></a>
</h2>
<div class="section level3">
<h3 id="what-is-hgwr-model">What is HGWR model?<a class="anchor" aria-label="anchor" href="#what-is-hgwr-model"></a>
</h3>
<p>Hierarchical and Geographically Weighted Regression, shorted for
HGWR, is a spatial modelling method designed for data of spatial
hierarchical structures. Just as its name implies, this is a combination
of Hierarchical Linear Model <span class="citation">[HLM, also known as
Multilevel Model, @Raudenbush-1993]</span> and Geographically Weighted
Regression <span class="citation">[GWR,
@BrunsdonFotheringham-1996]</span>. In this model, spatial effects are
divided into three types: global fixed, local fixed and random.
Formally, it is expressed as
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mi>G</mi><mi>γ</mi><mo>+</mo><mi>X</mi><mi>β</mi><mo>+</mo><mi>Z</mi><mi>μ</mi><mo>+</mo><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">
y = G\gamma + X\beta + Z\mu + \epsilon
</annotation></semantics></math> with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>y</mi><annotation encoding="application/x-tex">y</annotation></semantics></math>
the dependent variable,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>G</mi><annotation encoding="application/x-tex">G</annotation></semantics></math>
the group level independent variables,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>γ</mi><annotation encoding="application/x-tex">\gamma</annotation></semantics></math>
the local fixed effects,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>
also the group level independent variables,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
the global fixed effects,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math>
the individual level independent variables,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>μ</mi><annotation encoding="application/x-tex">\mu</annotation></semantics></math>
the random effects,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ϵ</mi><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math>
the individual errors.</p>
</div>
<div class="section level3">
<h3 id="why-hgwr-model">Why HGWR model?<a class="anchor" aria-label="anchor" href="#why-hgwr-model"></a>
</h3>
<p>As we know, hierarchical structure is commonly existing in spatial
data. For example, cities can be grouped by provinces or other
higher-level administrative district they belong to; house prices may
share some factors from the block; and students in one school have
different access to education resources with those in another school.
When dealing with this type of data, we usually choose HLM to address
the within-group homogeneity and the between-group heterogeneity. And
there are usually two types of variables: group-level variables and
sample-level variables. The formal ones are used to describe the
properties of groups (such as the provinces, blocks and schools); the
latter ones are observations of individual samples (such as the cities,
houses and students). The effect of some sample-level variables are
similar in all groups, thus they are modelled with fixed coefficients
(effects). For others, they are modelled individually, i.e., with random
effects.</p>
<p>However, for group-level variables, they can only be modelled with
fixed effects. For spatial data, we would encounter some problems.
According to the Tobler’s first law of Geography “Everything is related
to everything else, but near things are more related than distant
things” <span class="citation">[@Tobler-1970]</span>. If the model is
calibrated with equally weighted samples, spatial heterogeneity would be
overlooked <span class="citation">[@FotheringhamBrunsdon-2002]</span>.
Thus, it requires us to distinguish “local fixed effects” from “global
fixed effects” to discover spatial heterogeneity in group-level
variables.</p>
<p>But why not GWR or Multiscale GWR <span class="citation">[@FotheringhamYang-2017, LuBrunsdon-2017]</span>
Because when dealing with data of hierarchical structures, GWR is
problematic <span class="citation">[@HuLu-2022]</span>. We know that GWR
calibrate a model with unique coefficients on each sample by borrowing
data from its neighbours. And it uses a parameter “bandwidth” to control
how many neighbours are included. If samples are not hierarchically
structured, everything works well. However, just imagine a situation
like Figure 1. For the two samples of red color and blue color, we take
the same number of their neighbours, but actually the spatial extents
are not the same. In extreme cases, spatial extends of some samples
could be too small to hold more than one or two location, but some are
large enough. This would lead to the failure of bandwidth optimization
and reduce the reliability of the optimized bandwidth.</p>
<p>To solve the problems mentioned above, we need to use HGWR model. It
is able to modelling spatial hierarchical structure and spatial
heterogeneity simultaneously. Examples below can show that it works well
for spatial hierarchical data.</p>
</div>
</div>
<div class="section level2">
<h2 id="modelling-with-hgwr-model">Modelling with HGWR Model<a class="anchor" aria-label="anchor" href="#modelling-with-hgwr-model"></a>
</h2>
<p>The R package <strong>hgwrr</strong> is built for calibrating HGWR
model. In this section, we are going to show how to use it.</p>
<div class="section level3">
<h3 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h3>
<p>Package <strong>hgwrr</strong> is available on <a href="https://cran.r-project.org/package=hgwrr" class="external-link">CRAN</a>. Simply type
the following codes to install it.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"hgwrr"</span><span class="op">)</span></span></code></pre></div>
<p>Or download <a href="https://github.com/HPDell/hgwr/releases/latest" class="external-link">latest released
source package</a> and run the following command to install this
package.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="ex">R</span> CMD INSTALL hgwrr_0.2-0.tar.gz</span></code></pre></div>
<p>Note that <a href="https://cran.r-project.org/bin/windows/Rtools/" class="external-link">RTools</a> is
required on Windows.</p>
</div>
<div class="section level3">
<h3 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a>
</h3>
<p>We are going to show the usage of <strong>hgwrr</strong> package with
a simulated data.</p>
<p>First, we need to load this package in an R session.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/HPDell/hgwrr/" class="external-link">hgwrr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: sf</span></span>
<span><span class="co">#&gt; Linking to GEOS 3.10.2, GDAL 3.4.1, PROJ 8.2.1; sf_use_s2() is TRUE</span></span>
<span><span class="co">#&gt; Loading required package: MASS</span></span></code></pre></div>
<p>Then we can calibrate an HGWR model via <code><a href="../reference/hgwr.html">hgwr()</a></code>
function.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/hgwr.html">hgwr</a></span><span class="op">(</span></span>
<span>  <span class="va">formula</span>, <span class="va">data</span>, <span class="va">coords</span>, <span class="va">bw</span>,</span>
<span>  alpha <span class="op">=</span> <span class="fl">0.01</span>, eps_iter <span class="op">=</span> <span class="fl">1e-06</span>, eps_gradient <span class="op">=</span> <span class="fl">1e-06</span>, max_iters <span class="op">=</span> <span class="fl">1e+06</span>,</span>
<span>  max_retries <span class="op">=</span> <span class="fl">10</span>, ml_type <span class="op">=</span> <span class="va">HGWR_ML_TYPE_D_ONLY</span>, verbose <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The first five arguments are mandatory.</p>
<ul>
<li>
<p><code>formula</code> accepts a formula object in R. Its format
follows <strong>lme4</strong> package. As there are two types of
effects: fixed effects and random effects, we use the following format
to specify both of them:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dependent</span> <span class="op">~</span> <span class="fu">L</span><span class="op">(</span><span class="va">local.fixed</span><span class="op">)</span> <span class="op">+</span> <span class="va">fixed</span> <span class="op">+</span> <span class="op">(</span><span class="va">random</span> <span class="op">|</span> <span class="va">group</span><span class="op">)</span></span></code></pre></div>
</li>
<li><p><code>data</code> accepts a <code>data.frame</code> or a
<code>sf</code> object in R. All variables specified in
<code>formula</code> are extracted from <code>data</code>.</p></li>
<li><p>(Only needed when <code>data</code> is of type
<code>data.frame</code>) <code>coords</code> accepts a matrix of 2
columns. Each row is the longitude and latitude of each group.</p></li>
<li><p><code>bw</code> accepts a integer or numeric number to specify
the bandwidth used in geographically weighted process. Currently it can
only be adaptive bandwidth.</p></li>
</ul>
<p>Other arguments are optional which is used to control the backfitting
maximum likelihood algorithm. On most occasions the default values are
fine. If the default values cause some problems and you want change some
of them, please check the documentation of function <code><a href="../reference/hgwr.html">hgwr()</a></code>
for more information.</p>
</div>
<div class="section level3">
<h3 id="example-a-small-simulated-data-set">Example: A Small Simulated Data Set<a class="anchor" aria-label="anchor" href="#example-a-small-simulated-data-set"></a>
</h3>
<p><em>This example is used to show the usage of this package and to
test whether it works. We don’t care about how good the fitness of this
model is with this data set.</em></p>
<p>A data set “multisampling” is provided with this package,</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">multisampling</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">multisampling</span><span class="op">$</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt;           y        g1         g2         z1         x1 group</span></span>
<span><span class="co">#&gt; 1 1.2311965 0.1706889 -0.2246718  1.4808437  0.7930132     1</span></span>
<span><span class="co">#&gt; 2 2.7154442 0.1706889 -0.2246718  0.4890035  0.5222513     1</span></span>
<span><span class="co">#&gt; 3 1.9980754 0.1706889 -0.2246718 -0.2261288  1.7462222     1</span></span>
<span><span class="co">#&gt; 4 3.7671728 0.1706889 -0.2246718  0.3268472 -1.2713361     1</span></span>
<span><span class="co">#&gt; 5 4.4938533 0.1706889 -0.2246718  1.8754945  2.1973895     1</span></span>
<span><span class="co">#&gt; 6 0.7256683 0.1706889 -0.2246718 -0.3023764  0.4331308     1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">multisampling</span><span class="op">$</span><span class="va">coords</span><span class="op">)</span></span>
<span><span class="co">#&gt;          U        V</span></span>
<span><span class="co">#&gt; 1 2940.897 2851.943</span></span>
<span><span class="co">#&gt; 2 3002.659 3157.717</span></span>
<span><span class="co">#&gt; 3 2848.345 2904.326</span></span>
<span><span class="co">#&gt; 4 2863.735 2907.999</span></span>
<span><span class="co">#&gt; 5 3117.849 2800.236</span></span>
<span><span class="co">#&gt; 6 2906.585 2972.770</span></span></code></pre></div>
<p>where <code>y</code> is the dependent variable, <code>g1</code> and
<code>g2</code> are two group-level variables, <code>z1</code> and
<code>x1</code> are two sample-level variables, <code>group</code> are
the labels of the groups they belong to, and <code>U</code>,
<code>V</code> are longitude and latitude coordinate values of all
groups.</p>
<p>We regards <code>g1</code> and <code>g2</code> have local fixed
effects, <code>x1</code> have global fixed effects and <code>z1</code>
have random effects. Then we can calibrate an HGWR model with like
this</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ms_hgwr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hgwr.html">hgwr</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="fu">L</span><span class="op">(</span><span class="va">g1</span> <span class="op">+</span> <span class="va">g2</span><span class="op">)</span> <span class="op">+</span> <span class="va">x1</span> <span class="op">+</span> <span class="op">(</span><span class="va">z1</span> <span class="op">|</span> <span class="va">group</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">multisampling</span><span class="op">$</span><span class="va">data</span>,</span>
<span>  coords <span class="op">=</span> <span class="va">multisampling</span><span class="op">$</span><span class="va">coords</span>,</span>
<span>  bw <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="op">)</span></span>
<span><span class="va">ms_hgwr</span></span>
<span><span class="co">#&gt; Hierarchical and geographically weighted regression model</span></span>
<span><span class="co">#&gt; =========================================================</span></span>
<span><span class="co">#&gt; Formula: y ~ L(g1 + g2) + x1 + (z1 | group)</span></span>
<span><span class="co">#&gt;  Method: Back-fitting and Maximum likelihood</span></span>
<span><span class="co">#&gt;    Data: multisampling$data</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed Effects</span></span>
<span><span class="co">#&gt; -------------</span></span>
<span><span class="co">#&gt;  Intercept        x1 </span></span>
<span><span class="co">#&gt;   2.844509  0.966059 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Group-level Spatially Weighted Effects</span></span>
<span><span class="co">#&gt; --------------------------------------</span></span>
<span><span class="co">#&gt; Bandwidth: 10 (nearest neighbours)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficient estimates:</span></span>
<span><span class="co">#&gt;  Coefficient        Min  1st Quartile     Median  3rd Quartile        Max </span></span>
<span><span class="co">#&gt;    Intercept  -1.430985     -1.350693  -1.140097     -0.911629  -0.727237 </span></span>
<span><span class="co">#&gt;           g1   5.969397      6.328338   7.136143      7.447083   8.481628 </span></span>
<span><span class="co">#&gt;           g2  -0.683021      0.043467   0.887209      1.174541   1.521918 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample-level Random Effects</span></span>
<span><span class="co">#&gt; ---------------------------</span></span>
<span><span class="co">#&gt;    Groups       Name  Std.Dev.      Corr </span></span>
<span><span class="co">#&gt;     group  Intercept  1.921255           </span></span>
<span><span class="co">#&gt;                   z1  1.921255  0.000000 </span></span>
<span><span class="co">#&gt;  Residual             1.921255           </span></span>
<span><span class="co">#&gt;    Groups       Name  Std.Dev.      Corr </span></span>
<span><span class="co">#&gt;     group  Intercept  1.921255           </span></span>
<span><span class="co">#&gt;                   z1  1.921255  0.000000 </span></span>
<span><span class="co">#&gt;  Residual             1.921255           </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Other Information</span></span>
<span><span class="co">#&gt; -----------------</span></span>
<span><span class="co">#&gt; Number of Obs: 484</span></span>
<span><span class="co">#&gt;        Groups: group , 16</span></span></code></pre></div>
<p>The output of the model shows estimations of global fixed effects,
summary of those of local fixed effects. Also there are the standard
deviations of random effects and correlation coefficients between
them.</p>
<p>Then we can have a look on the coefficient estimations.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">ms_hgwr</span><span class="op">)</span></span>
<span><span class="co">#&gt;     Intercept       g1          g2        x1          z1</span></span>
<span><span class="co">#&gt; 1  0.63728385 7.718650  0.04654332 0.9660594 -0.19316953</span></span>
<span><span class="co">#&gt; 2  3.16626457 6.554636  1.33431862 0.9660594  0.28646830</span></span>
<span><span class="co">#&gt; 3  0.59681282 7.420539  0.79849908 0.9660594  1.27063639</span></span>
<span><span class="co">#&gt; 4  2.26041067 7.395640  0.86517318 0.9660594 -0.59984180</span></span>
<span><span class="co">#&gt; 5  5.72855111 8.481628 -0.68302067 0.9660594 -1.46606958</span></span>
<span><span class="co">#&gt; 6  0.35901307 6.235741  1.26283083 0.9660594  0.69526966</span></span>
<span><span class="co">#&gt; 7  2.39877444 7.650960 -0.02458224 0.9660594 -1.46161629</span></span>
<span><span class="co">#&gt; 8  2.96706662 7.274534 -0.09758977 0.9660594  0.32008996</span></span>
<span><span class="co">#&gt; 9  0.80004263 5.969397  0.95359748 0.9660594  0.60679673</span></span>
<span><span class="co">#&gt; 10 1.03852566 6.004158  1.52191830 0.9660594 -0.85534304</span></span>
<span><span class="co">#&gt; 11 0.88341276 6.997752  1.08577440 0.9660594  0.31273932</span></span>
<span><span class="co">#&gt; 12 0.19476251 7.473628  0.04039086 0.9660594 -0.41973900</span></span>
<span><span class="co">#&gt; 13 0.08539817 7.308281  0.90924576 0.9660594  1.57629379</span></span>
<span><span class="co">#&gt; 14 2.91084212 5.975806  1.10442026 0.9660594  0.01154764</span></span>
<span><span class="co">#&gt; 15 1.58219548 6.420936  1.24466256 0.9660594  0.04762966</span></span>
<span><span class="co">#&gt; 16 2.05821271 6.734675  0.26179176 0.9660594 -0.04494147</span></span></code></pre></div>
<p>With <strong>ggplot2</strong> or other packages, we can create some
figures.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">ms_hgwr_coef</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">multisampling</span><span class="op">$</span><span class="va">coords</span>, <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">ms_hgwr</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">ms_hgwr_coef</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">U</span>, y <span class="op">=</span> <span class="va">V</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">g1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>We can also convert it to spatial data and use <strong>tmap</strong>
to visualize.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-tmap.github.io/tmap/" class="external-link">tmap</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Breaking News: tmap 3.x is retiring. Please test v4, e.g. with</span></span>
<span><span class="co">#&gt; remotes::install_github('r-tmap/tmap')</span></span>
<span><span class="va">ms_hgwr_coef_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">ms_hgwr_coef</span>,</span>
<span>                            coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">multisampling</span><span class="op">$</span><span class="va">coords</span><span class="op">)</span>,</span>
<span>                            crs <span class="op">=</span> <span class="fl">27700</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">ms_hgwr_coef_sf</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_symbols.html" class="external-link">tm_dots</a></span><span class="op">(</span>col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"g1"</span>, <span class="st">"g2"</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="co">#&gt; Variable(s) "g2" contains positive and negative values, so midpoint is set to 0. Set midpoint = NA to show the full spectrum of the color palette.</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>And we can also fetch the fitted and residuals.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  real <span class="op">=</span> <span class="va">multisampling</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">y</span>,</span>
<span>  fitted <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted</a></span><span class="op">(</span><span class="va">ms_hgwr</span><span class="op">)</span>,</span>
<span>  residuals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">ms_hgwr</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;        real    fitted  residuals</span></span>
<span><span class="co">#&gt; 1 1.2311965 2.4243588 -1.1931623</span></span>
<span><span class="co">#&gt; 2 2.7154442 2.3543800  0.3610642</span></span>
<span><span class="co">#&gt; 3 1.9980754 3.6749504 -1.6768750</span></span>
<span><span class="co">#&gt; 4 3.7671728 0.6529918  3.1141810</span></span>
<span><span class="co">#&gt; 5 4.4938533 3.7048352  0.7890181</span></span>
<span><span class="co">#&gt; 6 0.7256683 2.4211548 -1.6954865</span></span></code></pre></div>
<p>The <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> function will give some statistical
information about this model.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ms_hgwr</span><span class="op">)</span></span>
<span><span class="co">#&gt; Hierarchical and geographically weighted regression model</span></span>
<span><span class="co">#&gt; =========================================================</span></span>
<span><span class="co">#&gt; Formula: y ~ L(g1 + g2) + x1 + (z1 | group)</span></span>
<span><span class="co">#&gt;  Method: Back-fitting and Maximum likelihood</span></span>
<span><span class="co">#&gt;    Data: multisampling$data</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Parameter Estimates</span></span>
<span><span class="co">#&gt; -------------------</span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;             Estimated   Sd. Err      t.val  Pr(&gt;|t|)      </span></span>
<span><span class="co">#&gt;  Intercept   2.844509  0.254491  11.177234  0.000000  *** </span></span>
<span><span class="co">#&gt;         x1   0.966059  0.046763  20.658467  0.000000  *** </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Bandwidth: 10 (nearest neighbours)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GLSW effects:</span></span>
<span><span class="co">#&gt;             Mean Est.  Mean Sd.   ***    **      *      . </span></span>
<span><span class="co">#&gt;  Intercept  -1.115285  0.543705  0.0%  0.0%  56.2%  18.8% </span></span>
<span><span class="co">#&gt;         g1   6.976060  3.128518  0.0%  6.2%  68.8%  25.0% </span></span>
<span><span class="co">#&gt;         g2   0.663998  3.158385  0.0%  0.0%   0.0%   0.0% </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SLR effects:</span></span>
<span><span class="co">#&gt;    Groups       Name      Mean  Std.Dev.      Corr </span></span>
<span><span class="co">#&gt;     group  Intercept  0.000000  1.921255           </span></span>
<span><span class="co">#&gt;                   z1  0.005422  1.921255  0.000000 </span></span>
<span><span class="co">#&gt;  Residual             0.233641  1.921255           </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Diagnostics</span></span>
<span><span class="co">#&gt; -----------</span></span>
<span><span class="co">#&gt;  rsquared  0.641698 </span></span>
<span><span class="co">#&gt;    logLik       NaN </span></span>
<span><span class="co">#&gt;       AIC       NaN </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Scaled Residuals</span></span>
<span><span class="co">#&gt; ----------------</span></span>
<span><span class="co">#&gt;        Min         1Q    Median        3Q       Max </span></span>
<span><span class="co">#&gt;  -5.222809  -0.982000  0.161400  1.480594  5.562956 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Other Information</span></span>
<span><span class="co">#&gt; -----------------</span></span>
<span><span class="co">#&gt; Number of Obs: 484</span></span>
<span><span class="co">#&gt;        Groups: group , 16</span></span></code></pre></div>
<p>On the current stage, only pseudo
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>R</mi><mn>2</mn></msup><annotation encoding="application/x-tex">R^2</annotation></semantics></math>
is available. In the future, more diagnostic information will be
provided in this package.</p>
</div>
<div class="section level3">
<h3 id="example-large-scale-simulated-data">Example: Large Scale Simulated Data<a class="anchor" aria-label="anchor" href="#example-large-scale-simulated-data"></a>
</h3>
<p>In the former example, there are only 484 observations and 16 groups.
They are not adequate enough to get precises estimations. Here, we are
going to use a large scale simulated data set to show the performance of
HGWR model. As the true value of coefficients are already known (stored
in variable <code>msl_beta</code>), closeness between estimated and true
values is an practical performance metric.</p>
<p>The data set is provided <a href="./data/example2.rda">here</a>. Its
structure is similar to data <code>multisampling</code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">multisampling.large</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">multisampling.large</span><span class="op">$</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt;          y        g1        g2         x1         z1 group</span></span>
<span><span class="co">#&gt; 1 2.090256 0.1933745 -0.057836  0.7930132  1.1432041     1</span></span>
<span><span class="co">#&gt; 2 3.456452 0.1933745 -0.057836  0.5222513  1.0198745     1</span></span>
<span><span class="co">#&gt; 3 2.876627 0.1933745 -0.057836  1.7462222 -0.7071740     1</span></span>
<span><span class="co">#&gt; 4 4.510162 0.1933745 -0.057836 -1.2713361  0.8431381     1</span></span>
<span><span class="co">#&gt; 5 5.583738 0.1933745 -0.057836  2.1973895 -0.1603318     1</span></span>
<span><span class="co">#&gt; 6 1.601511 0.1933745 -0.057836  0.4331308 -0.7634945     1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">multisampling.large</span><span class="op">$</span><span class="va">coords</span><span class="op">)</span></span>
<span><span class="co">#&gt;            V1       V2</span></span>
<span><span class="co">#&gt; [1,] 2940.897 2851.943</span></span>
<span><span class="co">#&gt; [2,] 3002.659 3157.717</span></span>
<span><span class="co">#&gt; [3,] 2848.345 2904.326</span></span>
<span><span class="co">#&gt; [4,] 2863.735 2907.999</span></span>
<span><span class="co">#&gt; [5,] 3117.849 2800.236</span></span>
<span><span class="co">#&gt; [6,] 2906.585 2972.770</span></span>
<span><span class="va">msl_beta</span> <span class="op">&lt;-</span> <span class="va">multisampling.large</span><span class="op">$</span><span class="va">beta</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">msl_beta</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Intercept        g1        g2          z1 x1</span></span>
<span><span class="co">#&gt; 1 0.7114818 11.309720  3.336208 -0.13592452  1</span></span>
<span><span class="co">#&gt; 2 1.6523106 12.438025  4.972805 -0.04079697  1</span></span>
<span><span class="co">#&gt; 3 1.4783712  6.876733 -5.069080  1.01053901  1</span></span>
<span><span class="co">#&gt; 4 3.2734732  6.088872 -3.877653 -0.15826244  1</span></span>
<span><span class="co">#&gt; 5 3.8245206 21.341706  3.814638 -2.15663750  1</span></span>
<span><span class="co">#&gt; 6 0.4886921  1.243364 -2.469626  0.49864683  1</span></span></code></pre></div>
<p>In this data, we also regards <code>g1</code> and <code>g2</code> as
two group-level variables, <code>z1</code> and <code>x1</code> as two
sample-level variables, <code>group</code> as the labels of the groups
they belong to, and <code>U</code>, <code>V</code> as longitude and
latitude coordinate values of all groups. Then we calibrate an HGWR
model.</p>
<blockquote>
<p>As the data is large (13862 observations), it may take some time to
get results.</p>
</blockquote>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">msl_hgwr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hgwr.html">hgwr</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="fu">L</span><span class="op">(</span><span class="va">g1</span> <span class="op">+</span> <span class="va">g2</span><span class="op">)</span> <span class="op">+</span> <span class="va">x1</span> <span class="op">+</span> <span class="op">(</span><span class="va">z1</span> <span class="op">|</span> <span class="va">group</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">multisampling.large</span><span class="op">$</span><span class="va">data</span>,</span>
<span>  coords <span class="op">=</span> <span class="va">multisampling.large</span><span class="op">$</span><span class="va">coords</span>,</span>
<span>  bw <span class="op">=</span> <span class="fl">32</span>, kernel <span class="op">=</span> <span class="st">"bisquared"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">msl_hgwr</span></span>
<span><span class="co">#&gt; Hierarchical and geographically weighted regression model</span></span>
<span><span class="co">#&gt; =========================================================</span></span>
<span><span class="co">#&gt; Formula: y ~ L(g1 + g2) + x1 + (z1 | group)</span></span>
<span><span class="co">#&gt;  Method: Back-fitting and Maximum likelihood</span></span>
<span><span class="co">#&gt;    Data: multisampling.large$data</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed Effects</span></span>
<span><span class="co">#&gt; -------------</span></span>
<span><span class="co">#&gt;  Intercept        x1 </span></span>
<span><span class="co">#&gt;   1.856041  1.010716 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Group-level Spatially Weighted Effects</span></span>
<span><span class="co">#&gt; --------------------------------------</span></span>
<span><span class="co">#&gt; Bandwidth: 32 (nearest neighbours)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficient estimates:</span></span>
<span><span class="co">#&gt;  Coefficient         Min  1st Quartile     Median  3rd Quartile        Max </span></span>
<span><span class="co">#&gt;    Intercept   -0.839777     -0.231721  -0.065754      0.095718   0.622823 </span></span>
<span><span class="co">#&gt;           g1   -3.110748      0.390257   3.637581      6.433589  12.076704 </span></span>
<span><span class="co">#&gt;           g2  -10.971950     -2.457583  -0.439274      1.977123   8.306397 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample-level Random Effects</span></span>
<span><span class="co">#&gt; ---------------------------</span></span>
<span><span class="co">#&gt;    Groups       Name  Std.Dev.      Corr </span></span>
<span><span class="co">#&gt;     group  Intercept  1.989349           </span></span>
<span><span class="co">#&gt;                   z1  1.989349  0.000000 </span></span>
<span><span class="co">#&gt;  Residual             1.989349           </span></span>
<span><span class="co">#&gt;    Groups       Name  Std.Dev.      Corr </span></span>
<span><span class="co">#&gt;     group  Intercept  1.989349           </span></span>
<span><span class="co">#&gt;                   z1  1.989349  0.000000 </span></span>
<span><span class="co">#&gt;  Residual             1.989349           </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Other Information</span></span>
<span><span class="co">#&gt; -----------------</span></span>
<span><span class="co">#&gt; Number of Obs: 13862</span></span>
<span><span class="co">#&gt;        Groups: group , 200</span></span></code></pre></div>
<div class="section level4">
<h4 id="fitness-assessment">Fitness Assessment<a class="anchor" aria-label="anchor" href="#fitness-assessment"></a>
</h4>
<p>Then we check the estimations of intercept, <code>g1</code>,
<code>g2</code> and <code>z1</code> via some scatter plots.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:MASS':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     select</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">msl_hgwr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Intercept</span>, <span class="va">g1</span>, <span class="va">g2</span>, <span class="va">z1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, Truth <span class="op">=</span> <span class="va">msl_beta</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">]</span>, Estimated <span class="op">=</span> <span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">pmap_df</a></span><span class="op">(</span><span class="va">data.frame</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">label</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Intercept"</span>, <span class="st">"g1"</span>, <span class="st">"g2"</span>, <span class="st">"z1"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Truth</span>, y <span class="op">=</span> <span class="va">Estimated</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">25</span>, <span class="fl">25</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">label</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-10-1.png" width="2700"></p>
<p>In addition to these scatter plots, root mean squared errors (RMSE)
and mean absolute errors of estimations and true values are also very
useful to assess the fitting performance.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">msl_hgwr_err</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">msl_hgwr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Intercept</span>, <span class="va">g1</span>, <span class="va">g2</span>, <span class="va">z1</span>, <span class="va">x1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>      MAE <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2_dbl</a></span><span class="op">(</span><span class="va">msl_beta</span>, <span class="va">.</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">.x</span> <span class="op">-</span> <span class="va">.y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      RMSE <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2_dbl</a></span><span class="op">(</span><span class="va">msl_beta</span>, <span class="va">.</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">.x</span> <span class="op">-</span> <span class="va">.y</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="va">msl_hgwr_err</span></span>
<span><span class="co">#&gt;      Intercept       g1       g2        z1         x1</span></span>
<span><span class="co">#&gt; MAE  0.3599828 2.367257 2.266689 0.2025208 0.01071645</span></span>
<span><span class="co">#&gt; RMSE 0.4910691 3.644679 2.976845 0.2576828 0.01071645</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="comparison-of-hgwr-gwr-and-hlm">Comparison of HGWR, GWR and HLM<a class="anchor" aria-label="anchor" href="#comparison-of-hgwr-gwr-and-hlm"></a>
</h4>
<p>As a comparison, we can also calibrate a GWR model and HLM model and
have a look at their fitting performance. The GWR model can be
calibrated with the following codes.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">enable_parallel</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.info.html" class="external-link">Sys.info</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="st">'sysname'</span><span class="op">]</span> <span class="op">!=</span> <span class="st">'Darwin'</span></span>
<span><span class="va">parallel_method</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">enable_parallel</span>, <span class="st">"omp"</span>, <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">parallel_arg</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">enable_parallel</span>, <span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span></span>
<span><span class="co">### GWR model</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://gwr.nuim.ie/" class="external-link">GWmodel</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: robustbase</span></span>
<span><span class="co">#&gt; Loading required package: sp</span></span>
<span><span class="co">#&gt; Loading required package: Rcpp</span></span>
<span><span class="co">#&gt; Welcome to GWmodel version 2.4-2.</span></span>
<span><span class="va">msl_gwr_data</span> <span class="op">&lt;-</span> <span class="va">multisampling.large</span><span class="op">$</span><span class="va">data</span></span>
<span><span class="fu"><a href="https://edzer.github.io/sp/reference/coordinates.html" class="external-link">coordinates</a></span><span class="op">(</span><span class="va">msl_gwr_data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">multisampling.large</span>, <span class="va">coords</span><span class="op">[</span><span class="va">data</span><span class="op">$</span><span class="va">group</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="co">##### Get optimized bandwidth via golden minimization algorithm.</span></span>
<span><span class="va">msl_gwr_bw</span> <span class="op">&lt;-</span> <span class="fl">265</span>  <span class="co"># The bandiwdth is pre-optimised to save time.</span></span>
<span><span class="co">##### Calibrate GWR model with optimized bandwidth.</span></span>
<span><span class="va">msl_gwr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/GWmodel/man/gwr.basic.html" class="external-link">gwr.basic</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">g1</span> <span class="op">+</span> <span class="va">g2</span> <span class="op">+</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">z1</span>,</span>
<span>  data <span class="op">=</span> <span class="va">msl_gwr_data</span>,</span>
<span>  bw <span class="op">=</span> <span class="va">msl_gwr_bw</span>,</span>
<span>  adaptive <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  parallel.method <span class="op">=</span> <span class="va">parallel_method</span>,</span>
<span>  parallel.arg <span class="op">=</span> <span class="va">parallel_arg</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#### Get coefficient estimations.</span></span>
<span><span class="co">#### As samples in one group have equal estimations,</span></span>
<span><span class="co">#### we use mean value of each group to represent them.</span></span>
<span><span class="va">msl_gwr_coef</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">msl_gwr</span><span class="op">$</span><span class="va">SDF</span><span class="op">@</span><span class="va">data</span>, group <span class="op">=</span> <span class="va">msl_gwr_data</span><span class="op">$</span><span class="va">group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Intercept</span>, <span class="va">g1</span>, <span class="va">g2</span>, <span class="va">x1</span>, <span class="va">z1</span>, <span class="va">group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html" class="external-link">summarise_all</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span></span>
<span><span class="co">##### Calculate RMSE and MAE of estimations.</span></span>
<span><span class="va">msl_gwr_err</span> <span class="op">&lt;-</span> <span class="va">msl_gwr_coef</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Intercept</span>, <span class="va">g1</span>, <span class="va">g2</span>, <span class="va">z1</span>, <span class="va">x1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>      MAE <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2_dbl</a></span><span class="op">(</span><span class="va">msl_beta</span>, <span class="va">.</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">.x</span> <span class="op">-</span> <span class="va">.y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      RMSE <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2_dbl</a></span><span class="op">(</span><span class="va">msl_beta</span>, <span class="va">.</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">.x</span> <span class="op">-</span> <span class="va">.y</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="va">msl_gwr_err</span></span>
<span><span class="co">#&gt;         Intercept           g1           g2        z1        x1</span></span>
<span><span class="co">#&gt; MAE  3.414899e+15 8.396317e+16 1.925287e+17 0.7135892 0.4244955</span></span>
<span><span class="co">#&gt; RMSE 4.168939e+16 1.006233e+18 2.338391e+18 2.7673018 2.6585412</span></span></code></pre></div>
<p>And also a HLM model calibrated with the following codes.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/" class="external-link">lme4</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: Matrix</span></span>
<span><span class="va">msl_hlm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">g1</span> <span class="op">+</span> <span class="va">g2</span> <span class="op">+</span> <span class="va">x1</span> <span class="op">+</span> <span class="op">(</span><span class="va">z1</span> <span class="op">|</span> <span class="va">group</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">multisampling.large</span><span class="op">$</span><span class="va">data</span></span>
<span><span class="op">)</span></span>
<span><span class="va">msl_hlm_coef</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">msl_hlm</span><span class="op">)</span><span class="op">$</span><span class="va">group</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">msl_hlm_coef</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">msl_hlm_coef</span><span class="op">)</span> <span class="op">==</span> <span class="st">"(Intercept)"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Intercept"</span></span>
<span><span class="va">msl_hlm_err</span> <span class="op">&lt;-</span> <span class="va">msl_hlm_coef</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Intercept</span>, <span class="va">g1</span>, <span class="va">g2</span>, <span class="va">z1</span>, <span class="va">x1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>      MAE <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2_dbl</a></span><span class="op">(</span><span class="va">msl_beta</span>, <span class="va">.</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">.x</span> <span class="op">-</span> <span class="va">.y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      RMSE <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2_dbl</a></span><span class="op">(</span><span class="va">msl_beta</span>, <span class="va">.</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">.x</span> <span class="op">-</span> <span class="va">.y</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="va">msl_hlm_err</span></span>
<span><span class="co">#&gt;      Intercept       g1       g2        z1        x1</span></span>
<span><span class="co">#&gt; MAE  0.5403015 3.961721 3.183228 0.2036397 0.0102346</span></span>
<span><span class="co">#&gt; RMSE 0.8043435 5.423963 4.610203 0.2584218 0.0102346</span></span></code></pre></div>
<p>A bar plot will be helpful here to compare the fitness of these three
models.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>HGWR <span class="op">=</span> <span class="va">msl_hgwr_err</span>, GWR <span class="op">=</span> <span class="va">msl_gwr_err</span>, HLM <span class="op">=</span> <span class="va">msl_hlm_err</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map2_dfr</a></span><span class="op">(</span><span class="va">.</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">nx</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map2_dfr</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">ni</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Coefficient <span class="op">=</span> <span class="va">ni</span>, Label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, Value <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>Algorithm <span class="op">=</span> <span class="va">nx</span>, <span class="va">.</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Coefficient</span>, y <span class="op">=</span> <span class="va">Value</span>, group <span class="op">=</span> <span class="va">Algorithm</span>, fill <span class="op">=</span> <span class="va">Algorithm</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span>position <span class="op">=</span> <span class="st">"dodge"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">Value</span>, <span class="fl">2</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">Value</span>, <span class="fl">10</span><span class="op">)</span>, vjust <span class="op">=</span> <span class="op">-</span><span class="fl">0.2</span><span class="op">)</span>,</span>
<span>              position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span><span class="fl">0.9</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span>rows <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">Label</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>, oob <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/oob.html" class="external-link">squish</a></span>,</span>
<span>                       expand <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expansion.html" class="external-link">expansion</a></span><span class="op">(</span>add <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-12-1.png" width="2187.5"></p>
<blockquote>
<p>Note that in this figure we limited the scale of y axis to make the
bar for <code>x1</code> and <code>z1</code> more obvious. The actual
numbers are labelled above bars.</p>
</blockquote>
<p>We can say that HGWR has best fitness among these three models. It is
able to give more precise estimations for local fixed effects. And it
can estimate global fixed effects and also random effects as precisely
as HLM does, but more precisely than GWR does.</p>
</div>
</div>
<div class="section level3">
<h3 id="case-study-impact-factors-of-house-price-in-wuhan">Case Study: Impact Factors of House Price in Wuhan<a class="anchor" aria-label="anchor" href="#case-study-impact-factors-of-house-price-in-wuhan"></a>
</h3>
<p>As the fitness of HGWR has been demonstrated with simulation data, we
are thing about applying it in collected data sets. Here we are going to
use a case study to show the usage of HGWR on this type of data. The
data set is provided as <code>wuhan.hp</code> by this package.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">wuhan.hp</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">wuhan.hp</span><span class="op">[</span><span class="st">"Price"</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>This data set, collected in 2018, has 19599 properties located in
19599 communities. In each observation, there are fields of house
properties, locational and neighbourhood variables. In details, they are
distances to nearby educational resources (kindergartens, primary
schools, middle schools, high schools, universities), commercial areas
(business districts, shopping malls and supermarkets), transportation
facilities (metro stations and bus stations), rivers, lakes, and green
lands. The following figure shows the distribution of these properties,
and the table gives information about all available variables.</p>
<table class="table">
<colgroup>
<col width="16%">
<col width="55%">
<col width="5%">
<col width="12%">
<col width="8%">
</colgroup>
<thead><tr class="header">
<th>Variables</th>
<th>Value</th>
<th>Level</th>
<th>Type</th>
<th>Logarithm</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><em>Price</em></td>
<td>House price per square metre.</td>
<td>Sample</td>
<td>Dependent</td>
<td>Yes</td>
</tr>
<tr class="even">
<td><em>Floor.High</em></td>
<td>1 if a property is on a high floor, otherwise 0.</td>
<td>Sample</td>
<td>Structural</td>
<td></td>
</tr>
<tr class="odd">
<td><em>Floor.Low</em></td>
<td>1 if a property is on a low floor, otherwise 0.</td>
<td>Sample</td>
<td>Structural</td>
<td></td>
</tr>
<tr class="even">
<td><em>Decoration.Fine</em></td>
<td>1 if a property is well decorated, otherwise 0.</td>
<td>Sample</td>
<td>Structural</td>
<td></td>
</tr>
<tr class="odd">
<td><em>PlateTower</em></td>
<td>1 if a property is of the plate-tower type, otherwise 0.</td>
<td>Sample</td>
<td>Structural</td>
<td></td>
</tr>
<tr class="even">
<td><em>Steel</em></td>
<td>1 if a property is of ‘steel’ structure, otherwise 0.</td>
<td>Sample</td>
<td>Structural</td>
<td></td>
</tr>
<tr class="odd">
<td><em>BuildingArea</em></td>
<td>Building area in square metres.</td>
<td>Sample</td>
<td>Structural</td>
<td>Yes</td>
</tr>
<tr class="even">
<td><em>Fee</em></td>
<td>Management fee per square meter per month.</td>
<td>Group</td>
<td>Neighbourhood</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td><em>d.Commercial</em></td>
<td>Distance to the nearest commercial area.</td>
<td>Group</td>
<td>Locational</td>
<td>Yes</td>
</tr>
<tr class="even">
<td><em>d.Greenland</em></td>
<td>Distance to the nearest green land.</td>
<td>Group</td>
<td>Locational</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td><em>d.Water</em></td>
<td>Distance to the nearest river or lake.</td>
<td>Group</td>
<td>Locational</td>
<td>Yes</td>
</tr>
<tr class="even">
<td><em>d.University</em></td>
<td>Distance to the nearest university.</td>
<td>Group</td>
<td>Locational</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td><em>d.HighSchool</em></td>
<td>Distance to the nearest high school.</td>
<td>Group</td>
<td>Locational</td>
<td>Yes</td>
</tr>
<tr class="even">
<td><em>d.MiddleSchool</em></td>
<td>Distance to the nearest middle school.</td>
<td>Group</td>
<td>Locational</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td><em>d.PrimarySchool</em></td>
<td>Distance to the nearest primary school.</td>
<td>Group</td>
<td>Locational</td>
<td>Yes</td>
</tr>
<tr class="even">
<td><em>d.Kindergarten</em></td>
<td>Distance to the nearest kindergarten.</td>
<td>Group</td>
<td>Locational</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td><em>d.SubwayStation</em></td>
<td>Distance to the nearest subway station.</td>
<td>Group</td>
<td>Locational</td>
<td>Yes</td>
</tr>
<tr class="even">
<td><em>d.Supermarket</em></td>
<td>Distance to the nearest supermarket.</td>
<td>Group</td>
<td>Locational</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td><em>d.ShoppingMall</em></td>
<td>Distance to the nearest shopping mall.</td>
<td>Group</td>
<td>Locational</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<p>A variable selection process <span class="citation">[@HuLu-2022]</span> suggests us to use the following
variables to build a HGWR model:</p>
<ul>
<li><em>Fee</em></li>
<li><em>d.Water</em></li>
<li><em>d.Commercial</em></li>
<li><em>d.PrimarySchool</em></li>
<li><em>d.Kindergarten</em></li>
<li><em>BuildingArea</em></li>
<li><em>Floor.High</em></li>
</ul>
<p>But we are going to append a variable <em>d.ShoppingMall</em> which
is usually concerned by customers and researchers. And regards the
locational and Fee as local fixed effects, the BuildingArea as global
fixed effects and Floor.High as random effects. Then we can calibrate a
HGWR model with the following codes.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">whhp_hgwr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hgwr.html">hgwr</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">Price</span> <span class="op">~</span> <span class="fu">L</span><span class="op">(</span><span class="va">d.Water</span> <span class="op">+</span> <span class="va">d.Commercial</span> <span class="op">+</span> <span class="va">d.Kindergarten</span> <span class="op">+</span> <span class="va">d.PrimarySchool</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="va">Fee</span> <span class="op">+</span> <span class="va">BuildingArea</span> <span class="op">+</span> <span class="va">d.ShoppingMall</span> <span class="op">+</span> <span class="op">(</span><span class="va">Floor.High</span> <span class="op">|</span> <span class="va">group</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">wuhan.hp</span>,</span>
<span>  bw <span class="op">=</span> <span class="st">"CV"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">whhp_hgwr</span></span>
<span><span class="co">#&gt; Hierarchical and geographically weighted regression model</span></span>
<span><span class="co">#&gt; =========================================================</span></span>
<span><span class="co">#&gt; Formula: </span></span>
<span><span class="co">#&gt; Price ~ L(d.Water + d.Commercial + d.Kindergarten + d.PrimarySchool) +  </span></span>
<span><span class="co">#&gt;     Fee + BuildingArea + d.ShoppingMall + (Floor.High | group)</span></span>
<span><span class="co">#&gt;  Method: Back-fitting and Maximum likelihood</span></span>
<span><span class="co">#&gt;    Data: wuhan.hp</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed Effects</span></span>
<span><span class="co">#&gt; -------------</span></span>
<span><span class="co">#&gt;  Intercept       Fee  BuildingArea  d.ShoppingMall </span></span>
<span><span class="co">#&gt;   9.905824  0.176803     -0.020361       -0.002869 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Group-level Spatially Weighted Effects</span></span>
<span><span class="co">#&gt; --------------------------------------</span></span>
<span><span class="co">#&gt; Bandwidth: 562 (nearest neighbours)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficient estimates:</span></span>
<span><span class="co">#&gt;      Coefficient        Min  1st Quartile     Median  3rd Quartile        Max </span></span>
<span><span class="co">#&gt;        Intercept  -0.255465     -0.217436  -0.196229     -0.160231  -0.136330 </span></span>
<span><span class="co">#&gt;          d.Water  -2.455754     -2.132142  -1.918264     -1.767405  -1.485196 </span></span>
<span><span class="co">#&gt;     d.Commercial  -4.637517     -4.456327  -4.275131     -3.973180  -3.840621 </span></span>
<span><span class="co">#&gt;   d.Kindergarten  -0.035458     -0.031036  -0.027930     -0.025192  -0.021800 </span></span>
<span><span class="co">#&gt;  d.PrimarySchool  -0.041803     -0.040628  -0.039498     -0.038174  -0.037094 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample-level Random Effects</span></span>
<span><span class="co">#&gt; ---------------------------</span></span>
<span><span class="co">#&gt;    Groups        Name  Std.Dev.       Corr </span></span>
<span><span class="co">#&gt;     group   Intercept  0.151359            </span></span>
<span><span class="co">#&gt;            Floor.High  0.079724  -0.022868 </span></span>
<span><span class="co">#&gt;  Residual              0.081436            </span></span>
<span><span class="co">#&gt;    Groups        Name  Std.Dev.       Corr </span></span>
<span><span class="co">#&gt;     group   Intercept  0.151359            </span></span>
<span><span class="co">#&gt;            Floor.High  0.079724  -0.022868 </span></span>
<span><span class="co">#&gt;  Residual              0.081436            </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Other Information</span></span>
<span><span class="co">#&gt; -----------------</span></span>
<span><span class="co">#&gt; Number of Obs: 19599</span></span>
<span><span class="co">#&gt;        Groups: group , 776</span></span></code></pre></div>
<div class="section level4">
<h4 id="coefficient-visualization">Coefficient Visualization<a class="anchor" aria-label="anchor" href="#coefficient-visualization"></a>
</h4>
<p>We can also make some maps to visualize the estimated coefficients.
<a href="https://raw.githubusercontent.com/hpdell/hgwr/docs/data/wuhan.geojson" class="external-link">Boundary
data of Wuhan</a> is provided. It is in GeoJSON format and can be loaded
by package <strong>rgdal</strong>. For coefficients, we can simply
combine it with coordinates of houses. Because coefficients, coordinates
and groups can be one-to-one matched.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wuhan</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/hpdell/hgwr/docs/data/wuhan.geojson"</span><span class="op">)</span></span>
<span><span class="va">wuhan_hp_groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_centroid</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">wuhan.hp</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">wuhan.hp</span><span class="op">$</span><span class="va">group</span><span class="op">)</span>, <span class="va">mean</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">wuhp_coef_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">whhp_hgwr</span><span class="op">)</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">wuhan_hp_groups</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">4547</span><span class="op">)</span></span>
<span><span class="va">wh_basemap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">wuhan</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_polygons.html" class="external-link">tm_polygons</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span></span></code></pre></div>
<p>Then visualize coefficients estimations with the basemap.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">whhp_hgwr</span><span class="op">$</span><span class="va">effects</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">local.fixed</span>, <span class="va">random</span>, <span class="va">global.fixed</span>, <span class="st">"Intercept"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">var</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">wh_basemap</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">wuhp_coef_sf</span>, is.master <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_symbols.html" class="external-link">tm_dots</a></span><span class="op">(</span>col <span class="op">=</span> <span class="va">var</span>, size <span class="op">=</span> <span class="fl">0.1</span>, midpoint <span class="op">=</span> <span class="fl">0</span>,</span>
<span>              palette <span class="op">=</span> <span class="st">"-RdBu"</span>, legend.col.reverse <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tmap_arrange.html" class="external-link">tmap_arrange</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/whhp-hgwr-coef-1.png" width="2700"></p>
<p>From this figure, we can see that as <em>BuildingArea</em> is
regarded as global fixed effects, for all samples there is only one
estimations. As <em>Floor.High</em> is regarded as random effects, each
group has a unique estimation but no spatial relationship can be seen.
For local fixed effects, their estimations seems to be locally related.
This is suggested by the first law of geography. Besides, spatial
heterogeneity is also obvious in their estimations.</p>
</div>
<div class="section level4">
<h4 id="residual-analysis">Residual Analysis<a class="anchor" aria-label="anchor" href="#residual-analysis"></a>
</h4>
<p>Via the standard function <code><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals()</a></code>, we have the
access to residuals estimated by this model. Then we can visualize them
by combining the summary statistics of residuals with coordinates. For
example, here we created a map showing mean residual of each group
together with standard deviation.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">whhp_hgwr_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  residuals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">whhp_hgwr</span><span class="op">)</span>,</span>
<span>  group <span class="op">=</span> <span class="va">wuhan.hp</span><span class="op">$</span><span class="va">group</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>res.abs.mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">residuals</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            res.sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">residuals</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">wuhan_hp_groups</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">4547</span><span class="op">)</span></span>
<span><span class="va">wh_basemap</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">whhp_hgwr_res</span>, is.master <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_symbols.html" class="external-link">tm_dots</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"res.abs.mean"</span>, size <span class="op">=</span> <span class="st">"res.sd"</span>, midpoint <span class="op">=</span> <span class="fl">0</span>,</span>
<span>          palette <span class="op">=</span> <span class="st">"-RdBu"</span>, legend.col.reverse <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<p>And we can also convey a global Moran test on the residuals to to
find well estimated points.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/spdep/" class="external-link">spdep</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: spData</span></span>
<span><span class="co">#&gt; To access larger datasets in this package, install the spDataLarge</span></span>
<span><span class="co">#&gt; package with: `install.packages('spDataLarge',</span></span>
<span><span class="co">#&gt; repos='https://nowosad.github.io/drat/', type='source')`</span></span>
<span><span class="va">whhp_hgwr_res_listw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">whhp_hgwr_res</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/knearneigh.html" class="external-link">knearneigh</a></span><span class="op">(</span>k <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/knn2nb.html" class="external-link">knn2nb</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2listw.html" class="external-link">nb2listw</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2listw.html" class="external-link">listw2U</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/moran.test.html" class="external-link">moran.test</a></span><span class="op">(</span><span class="va">whhp_hgwr_res</span><span class="op">$</span><span class="va">res.abs.mean</span>, <span class="va">whhp_hgwr_res_listw</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Moran I test under randomisation</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data:  whhp_hgwr_res$res.abs.mean  </span></span>
<span><span class="co">#&gt; weights: whhp_hgwr_res_listw    </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Moran I statistic standard deviate = 6.1948, p-value = 2.918e-10</span></span>
<span><span class="co">#&gt; alternative hypothesis: greater</span></span>
<span><span class="co">#&gt; sample estimates:</span></span>
<span><span class="co">#&gt; Moran I statistic       Expectation          Variance </span></span>
<span><span class="co">#&gt;      0.0639606679     -0.0012903226      0.0001109483</span></span></code></pre></div>
<p>From the p-value and Moran’s I value, we can find that although it is
suggested to reject the null hypothesis, the global spatial
autocorrelation is too weak to take any effects. Additionally, a local
Moran test is also useful.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">whhp_hgwr_res_localmoran</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/localmoran.html" class="external-link">localmoran</a></span><span class="op">(</span><span class="va">whhp_hgwr_res</span><span class="op">$</span><span class="va">res.abs.mean</span>, <span class="va">whhp_hgwr_res_listw</span><span class="op">)</span></span>
<span><span class="va">wh_basemap</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">whhp_hgwr_res</span>, <span class="va">whhp_hgwr_res_localmoran</span><span class="op">)</span>, is.master <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_symbols.html" class="external-link">tm_dots</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"Ii"</span>, size <span class="op">=</span> <span class="fl">0.2</span>, palette <span class="op">=</span> <span class="st">"-RdBu"</span>, style <span class="op">=</span> <span class="st">"quantile"</span>,</span>
<span>          midpoint <span class="op">=</span> <span class="fl">0</span>, title <span class="op">=</span> <span class="st">"Local Moran"</span><span class="op">)</span></span>
<span><span class="va">whhp_hgwr_res</span><span class="op">$</span><span class="va">res_c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">whhp_hgwr_res</span><span class="op">$</span><span class="va">res.abs.mean</span>, scale <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="va">whhp_hgwr_res</span><span class="op">$</span><span class="va">lmoran_c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">whhp_hgwr_res_localmoran</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, scale <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="va">whhp_hgwr_res</span><span class="op">$</span><span class="va">quadrant</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">whhp_hgwr_res</span>, <span class="op">{</span></span>
<span>  <span class="va">quadrant</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">res_c</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">quadrant</span><span class="op">[</span><span class="va">res_c</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">lmoran_c</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  <span class="va">quadrant</span><span class="op">[</span><span class="va">res_c</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">lmoran_c</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span>  <span class="va">quadrant</span><span class="op">[</span><span class="va">res_c</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">lmoran_c</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span>  <span class="va">quadrant</span><span class="op">[</span><span class="va">res_c</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">lmoran_c</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">4</span></span>
<span>  <span class="va">quadrant</span><span class="op">[</span><span class="va">whhp_hgwr_res_localmoran</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">0.1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">quadrant</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">LISA_palette</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"Insignificant"</span> <span class="op">=</span> <span class="st">"green"</span>, <span class="st">"Low-Low"</span> <span class="op">=</span> <span class="st">"darkblue"</span>, <span class="st">"Low-High"</span> <span class="op">=</span> <span class="st">"blue"</span>,</span>
<span>  <span class="st">"High-Low"</span> <span class="op">=</span> <span class="st">"red"</span>, <span class="st">"High-High"</span> <span class="op">=</span> <span class="st">"darkred"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_layout.html" class="external-link">tm_layout</a></span><span class="op">(</span>aes.palette <span class="op">=</span> <span class="st">"cat"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">wh_basemap</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">whhp_hgwr_res</span>, is.master <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_symbols.html" class="external-link">tm_dots</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"quadrant"</span>, size <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>          palette <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">LISA_palette</span><span class="op">)</span><span class="op">)</span>,</span>
<span>          labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">LISA_palette</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-17-1.png" width="49%"><img src="introduction_files/figure-html/unnamed-chunk-17-2.png" width="49%"></p>
<p>It can be seen that most residuals are not spatially clustered. Most
of those showing spatial clusters locate near the boundary of this study
area.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Yigong Hu.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
